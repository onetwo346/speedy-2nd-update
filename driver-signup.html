<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speedy Delivery - Driver Sign Up</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="auth.js"></script>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h1 class="h4 mb-0">Driver Sign Up</h1>
                            <a href="driver-login.html" class="text-decoration-none">Back to login</a>
                        </div>

                        <div class="alert alert-info mb-4" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Join our driver network!</strong> Submit your details and verification photos to start earning with deliveries across Winneba, Swedru, Nsaba, Nyakrom and Central Region.
                        </div>

                        <div id="signup-alert"></div>

                        <form id="signup-form">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="fullName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="fullName" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone" required>
                                </div>
                                <div class="col-12">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="col-12">
                                    <label for="homeAddress" class="form-label">Home Address <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="homeAddress" rows="3" placeholder="Enter your complete home address for delivery assignments" required></textarea>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Example: House Number 25, Near Winneba Junction, Winneba or Main Street, Swedru Market Area
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password" autocomplete="new-password" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="confirmPassword" class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control" id="confirmPassword" autocomplete="new-password" required>
                                </div>

                                <div class="col-12">
                                    <div class="border rounded p-3 bg-white">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <div class="fw-semibold">Driver License Photos</div>
                                                <div class="text-muted small">Upload clear photos of your license front and back.</div>
                                            </div>
                                            <span class="badge bg-secondary" id="licenseStatus">0/2</span>
                                        </div>

                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="licenseFront" class="form-label">License Front</label>
                                                <input type="file" class="form-control" id="licenseFront" accept="image/*" capture="environment" required>
                                                <div class="mt-2" id="licenseFrontPreview" style="display:none;">
                                                    <img class="img-fluid rounded border" id="licenseFrontImg" alt="License front preview">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="licenseBack" class="form-label">License Back</label>
                                                <input type="file" class="form-control" id="licenseBack" accept="image/*" capture="environment" required>
                                                <div class="mt-2" id="licenseBackPreview" style="display:none;">
                                                    <img class="img-fluid rounded border" id="licenseBackImg" alt="License back preview">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="border rounded p-3 bg-white">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <div class="fw-semibold">Selfie Verification</div>
                                                <div class="text-muted small">Take a clear photo of your face in good lighting.</div>
                                            </div>
                                            <span class="badge bg-secondary" id="selfieStatus">0/1</span>
                                        </div>

                                        <label for="selfie" class="form-label">Selfie</label>
                                        <input type="file" class="form-control" id="selfie" accept="image/*" capture="user" required>
                                        <div class="mt-2" id="selfiePreview" style="display:none;">
                                            <img class="img-fluid rounded border" id="selfieImg" alt="Selfie preview" style="max-height: 320px;">
                                        </div>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary w-100" id="signupBtn">Create Account</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <a href="admin-login.html" class="text-decoration-none">Admin login</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const alertBox = document.getElementById('signup-alert');
        const form = document.getElementById('signup-form');
        const signupBtn = document.getElementById('signupBtn');

        let licenseFrontData = null;
        let licenseBackData = null;
        let selfieData = null;

        const licenseFrontInput = document.getElementById('licenseFront');
        const licenseBackInput = document.getElementById('licenseBack');
        const selfieInput = document.getElementById('selfie');

        const licenseFrontPreview = document.getElementById('licenseFrontPreview');
        const licenseBackPreview = document.getElementById('licenseBackPreview');
        const selfiePreview = document.getElementById('selfiePreview');

        const licenseFrontImg = document.getElementById('licenseFrontImg');
        const licenseBackImg = document.getElementById('licenseBackImg');
        const selfieImg = document.getElementById('selfieImg');

        const licenseStatus = document.getElementById('licenseStatus');
        const selfieStatus = document.getElementById('selfieStatus');

        const showAlert = (message, type) => {
            alertBox.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
        };

        const readFileAsDataUrl = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject(new Error('File read failed'));
            reader.readAsDataURL(file);
        });

        const fileToCompressedDataUrl = async (file, maxDim, quality) => {
            const original = await readFileAsDataUrl(file);
            try {
                const img = new Image();
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = original;
                });

                const width = img.naturalWidth || img.width;
                const height = img.naturalHeight || img.height;
                const largest = Math.max(width, height);
                const scale = largest > maxDim ? (maxDim / largest) : 1;

                const targetW = Math.max(1, Math.round(width * scale));
                const targetH = Math.max(1, Math.round(height * scale));

                const canvas = document.createElement('canvas');
                canvas.width = targetW;
                canvas.height = targetH;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, targetW, targetH);

                return canvas.toDataURL('image/jpeg', quality);
            } catch {
                return original;
            }
        };

        const updateCounts = () => {
            const licenseCount = (licenseFrontInput.files.length ? 1 : 0) + (licenseBackInput.files.length ? 1 : 0);
            licenseStatus.textContent = `${licenseCount}/2`;
            licenseStatus.className = `badge ${licenseCount === 2 ? 'bg-success' : 'bg-secondary'}`;

            const selfieCount = selfieInput.files.length ? 1 : 0;
            selfieStatus.textContent = `${selfieCount}/1`;
            selfieStatus.className = `badge ${selfieCount === 1 ? 'bg-success' : 'bg-secondary'}`;
        };

        const attachPreview = (input, imgEl, previewEl, setData, maxDim, quality) => {
            input.addEventListener('change', async () => {
                updateCounts();
                const file = input.files && input.files[0];
                if (!file) {
                    previewEl.style.display = 'none';
                    setData(null);
                    return;
                }
                if (file.size > 3 * 1024 * 1024) {
                    input.value = '';
                    previewEl.style.display = 'none';
                    updateCounts();
                    setData(null);
                    showAlert('Please choose an image under 3MB.', 'warning');
                    return;
                }
                const dataUrl = await fileToCompressedDataUrl(file, maxDim, quality);
                setData(dataUrl);
                imgEl.src = dataUrl;
                previewEl.style.display = 'block';
            });
        };

        attachPreview(licenseFrontInput, licenseFrontImg, licenseFrontPreview, (v) => { licenseFrontData = v; }, 1600, 0.85);
        attachPreview(licenseBackInput, licenseBackImg, licenseBackPreview, (v) => { licenseBackData = v; }, 1600, 0.85);
        attachPreview(selfieInput, selfieImg, selfiePreview, (v) => { selfieData = v; }, 1200, 0.80);
        updateCounts();

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showAlert('Passwords do not match.', 'danger');
                return;
            }

            if (!licenseFrontData || !licenseBackData || !selfieData) {
                showAlert('Please upload license front, license back, and a selfie.', 'danger');
                return;
            }

            signupBtn.disabled = true;
            signupBtn.textContent = 'Creating account...';

            try {
                const result = await speedyRegisterDriver({
                    fullName,
                    email,
                    phone,
                    password,
                    licenseFront: licenseFrontData,
                    licenseBack: licenseBackData,
                    selfie: selfieData
                });

                if (!result.ok) {
                    showAlert(result.message || 'Sign up failed', 'danger');
                    signupBtn.disabled = false;
                    signupBtn.textContent = 'Create Account';
                    return;
                }

                const loginResult = await speedyLogin({ role: 'driver', username: email, password });
                if (!loginResult.ok) {
                    showAlert('Account created. Please log in.', 'success');
                    setTimeout(() => {
                        window.location.replace('driver-login.html');
                    }, 800);
                    return;
                }

                showAlert('Account created successfully. Redirecting to driver portal...', 'success');
                setTimeout(() => {
                    window.location.replace('driver.html');
                }, 400);

            } catch (err) {
                showAlert('Sign up failed. Please try again.', 'danger');
                signupBtn.disabled = false;
                signupBtn.textContent = 'Create Account';
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
