<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speedy Delivery - Driver Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="auth.js"></script>
    <script>
        (function () {
            const session = typeof speedyGetSession === 'function' ? speedyGetSession() : null;
            if (session && session.role === 'driver') {
                window.location.replace('driver.html');
            }
        })();
    </script>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <img src="4A7E09DF-D8AF-4D29-893B-65FDDB319BED.png" alt="Speedy Delivery Logo" style="height: 60px; width: auto;">
                        </div>
                        <h1 class="h4 mb-3 text-center">Driver Portal</h1>
                        <p class="text-center text-muted mb-4">
                            <i class="fas fa-truck me-2"></i>
                            Sign up as a driver to start earning with deliveries across Central Region
                        </p>
                        <div id="login-alert"></div>
                        <form id="login-form">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" autocomplete="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" autocomplete="current-password" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Login</button>
                        </form>
                        <div class="text-center mt-3">
                            <a href="#" class="text-decoration-none" id="forgot-password-link">Forgot password?</a>
                        </div>
                        <div class="text-center mt-2">
                            <a href="driver-signup.html" class="text-decoration-none">Create driver account</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="driverResetModal" tabindex="-1" aria-labelledby="driverResetModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="driverResetModalLabel">Reset Driver Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="reset-alert"></div>
                    <div class="mb-3">
                        <label for="reset-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="reset-email" autocomplete="email" placeholder="Enter your registered email" />
                    </div>
                    <div class="mb-3">
                        <label for="reset-phone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="reset-phone" autocomplete="tel" placeholder="Enter your registered phone" />
                    </div>
                    <div class="mb-2">
                        <label for="reset-password" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="reset-password" autocomplete="new-password" />
                    </div>
                    <div class="mb-2">
                        <label for="reset-password2" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="reset-password2" autocomplete="new-password" />
                    </div>
                    <div class="text-muted small mt-2">
                        For security, we verify your account using your email and phone number.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="reset-save-btn">Reset Password</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('login-form');
        const alertBox = document.getElementById('login-alert');

        const showAlert = (message, type) => {
            alertBox.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
        };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            const result = await speedyLogin({ role: 'driver', username, password });
            if (!result.ok) {
                showAlert(result.message || 'Login failed', 'danger');
                return;
            }

            window.location.replace('driver.html');
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const forgotLink = document.getElementById('forgot-password-link');
        const resetModalEl = document.getElementById('driverResetModal');
        const resetModal = resetModalEl ? new bootstrap.Modal(resetModalEl) : null;
        const resetAlertEl = document.getElementById('reset-alert');
        const resetSaveBtn = document.getElementById('reset-save-btn');

        const showResetAlert = (message, type) => {
            resetAlertEl.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
        };

        if (forgotLink && resetModal) {
            forgotLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (resetAlertEl) resetAlertEl.innerHTML = '';
                document.getElementById('reset-email').value = '';
                document.getElementById('reset-phone').value = '';
                document.getElementById('reset-password').value = '';
                document.getElementById('reset-password2').value = '';
                resetModal.show();
            });
        }

        if (resetSaveBtn) {
            resetSaveBtn.addEventListener('click', async () => {
                const email = document.getElementById('reset-email').value.trim();
                const phone = document.getElementById('reset-phone').value.trim();
                const p1 = document.getElementById('reset-password').value;
                const p2 = document.getElementById('reset-password2').value;

                if (!email || !phone || !p1 || !p2) {
                    showResetAlert('Please fill in all fields.', 'warning');
                    return;
                }
                if (p1.length < 6) {
                    showResetAlert('Password must be at least 6 characters.', 'warning');
                    return;
                }
                if (p1 !== p2) {
                    showResetAlert('Passwords do not match.', 'warning');
                    return;
                }
                if (typeof speedyDriverResetPassword !== 'function') {
                    showResetAlert('Password reset is not available right now.', 'danger');
                    return;
                }

                resetSaveBtn.disabled = true;
                try {
                    const res = await speedyDriverResetPassword({ email, phone, newPassword: p1 });
                    if (!res || !res.ok) {
                        showResetAlert((res && res.message) ? res.message : 'Failed to reset password.', 'danger');
                        return;
                    }
                    showResetAlert('Password reset successful. You can now log in with your new password.', 'success');
                    setTimeout(() => {
                        try { resetModal.hide(); } catch { }
                    }, 800);
                } finally {
                    resetSaveBtn.disabled = false;
                }
            });
        }
    </script>
</body>
</html>
